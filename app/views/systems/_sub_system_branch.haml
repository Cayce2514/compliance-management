-expanded = local_assigns.has_key?(:expanded) && expanded

-systems.each do |system|
  %li.system-node
    .row-fluid
      .span12
        .slot.subsystemslot.span12{ :'data-toggle' => 'collapse', :'data-target' => "#content_system_#{system.id}" }
          /-if !system.description.blank?
          .expander{ :class => expanded && 'in' }
          %a.btn.btn-blue.fltrt{ :href => flow_system_path(system) }
            Go
          %a.btn.btn-blue.fltrt{ :href => edit_flow_system_path(system), :'data-toggle' => 'modal-ajax-form', :'data-modal-reset' => 'reset' }
            Edit
          %span.prefix=system.slug
          =system.title || system.description
      .row-fluid-slotcontent.collapse{ :id => "content_system_#{system.id}" }
        .span12
          =system.description
    %ul.collapse{ :class => expanded && 'in', :xid => "content_system_#{system.id}" }
      =walk_slug_tree(Program.slugtree(system.controls)) do |item, step|
        .row-fluid
          .span12
            .slot.controlslot.span12{ :'data-toggle' => 'collapse', :'data-target' => "#content_item_#{item.id}" }
              /-if !item.description.blank?
              .expander
              %span.prefix=item.slug
              =item.title || item.description
          .row-fluid-slotcontent.collapse{ :id => "content_item_#{item.id}" }
            .span9
              =item.description
      -subsystems = system.sub_systems.all
      -if subsystems.count > 0
        %li
          %ul
            =render :partial => 'sub_system_branch', :locals => { :systems => subsystems }
